<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>부소산 파노라마 지도</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & Pannellum -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />

  <style>
    :root{
      --page-max-w: 1200px;
      --side-gap: 32px;
      --header-h: 120px;
      --between-gap: 24px;
      --map-bottom-gap: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, #f9fdfd 0%, #eefdf3 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
    }

    .page {
      min-height: 100%;
      max-width: var(--page-max-w);
      margin: 0 auto;
      padding: 0 var(--side-gap);
      display: flex;
      flex-direction: column;
    }

    #header {
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 12px;
      background: #f0fff4;
      border-radius: 14px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      border: 2px solid rgba(0, 0, 0, 0.15);
    }
    #title {
      font-size: 30px;
      font-weight: 800;
      color: #555;
      text-shadow: 1px 2px 6px rgba(0,0,0,0.25);
    }

    .map-wrap {
      position: relative;
      height: calc(100vh - var(--header-h) - var(--between-gap) - var(--map-bottom-gap));
      margin-top: var(--between-gap);
      margin-bottom: var(--map-bottom-gap);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      background: #eef7ff;
      border: 2px solid rgba(0, 0, 0, 0.12);
    }

    #map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    
    .leaflet-container { background: transparent !important; }
    
    #controls {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1000;
      display: none;
    }
    #controls button {
      margin-right: 8px;
      padding: 8px 12px;
      border: 0;
      border-radius: 8px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-weight: 600;
      color: #083a57;
      cursor: pointer;
    }
    #controls button:hover { background: #ffffff; }
    
    
    /* 📍 버튼 스타일 */
    .leaflet-control-addmarker {
      background: white;
      border: 1px solid #ccc;
      width: 30px;
      height: 30px;
      line-height: 28px;
      font-size: 18px;
      text-align: center;
      cursor: pointer;
    }
    .leaflet-control-addmarker.active { background: #ffe082; }
    
    /* ℹ️ 버튼 스타일 */
    .leaflet-control-info {
      background: white;
      border: 1px solid #ccc;
      width: 30px;
      height: 30px;
      line-height: 28px;
      font-size: 18px;
      text-align: center;
      cursor: pointer;
    }
    
    
    @media (max-width: 640px){
      :root{ --header-h: 96px; --side-gap: 16px; }
      #title{ font-size: 28px; }
    }
    
    #popup {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      width: 800px;
      max-width: 90%;
      display: none;
      flex-direction: column;
      align-items: center;
    }
    #popup.show {
      display: flex;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    #popup.hide {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
    }
    #popup .popup-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #popup-close {
      position: absolute;
      top: 10px;
      right: 12px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: #444;
    }
    /* #popup-close:hover {
      color: red;
    } */

    #popup-panorama {
        width: 750px;
        height: 400px;   /* 원하는 크기 (예: 300~400px) */
        border-radius: 8px;
        margin-top: 10px;
    }
    
    #overlay {
      position: fixed;
      inset: 0;   /* top, left, right, bottom = 0 */
      background: rgba(0,0,0,0.3);
      z-index: 1500;
      display: none;
    }
    #overlay.show { display: block; }

    
    /* 태그 선택 팝업 */
    #tagPopup {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; padding:16px; border-radius:12px;
      box-shadow:0 12px 32px rgba(0,0,0,0.25);
      z-index:2200; display:none;
      width:360px; max-width:90%;
    }
    #tagList { display:flex; flex-wrap:wrap; gap:8px; max-height:180px; overflow:auto; }
    .tag-chip {
      border:1px solid #ddd; border-radius:999px;
      padding:6px 10px; cursor:pointer; background:#fafafa; font-size:13px;
    }
    .tag-chip.selected { background:#ffe082; border-color:#f5c84c; }
    #tagActions { margin-top:12px; display:flex; gap:8px; justify-content:flex-end; }
    #tagActions button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; cursor:pointer; background:#fff; }
    #tagActions button.primary { background:#1e90ff; color:#fff; border-color:#1e90ff; }

    /* 마커 정보 표 팝업 */
    #infoPopup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2200;
      display: none;
      width: 400px;
      max-width: 90%;
    }
    #infoPopup h3 { margin-top:0; margin-bottom:12px; }
    #infoTable table { width:100%; border-collapse: collapse; }
    #infoTable th, #infoTable td {
      border:1px solid #ddd; padding:6px 8px; font-size:14px; text-align:left;
    }
    #infoTable th { background:#f5f5f5; }
    
    .leaflet-container { background:transparent !important; }
    .leaflet-control-addmarker,
    .leaflet-control-infotable,
    .leaflet-control-tagsearch,
    .leaflet-control-info {
      background:white; border:1px solid #ccc;
      width:30px; height:30px; line-height:28px;
      font-size:18px; text-align:center; cursor:pointer;
    }
    .leaflet-control-addmarker.active { background:#ffe082; }

    .leaflet-tooltip {
      background-color: rgba(255,255,255,0.5);
      border-radius: 12px;
      color: #333; font-weight: bold; font-size: 12px;
      padding: 6px 10px;
    }
  </style>
</head>

<body>
  <!-- ==================== HTML ==================== -->
  <div class="page">
    <header id="header">
      <div id="title">🗺️ 부소산 파노라마 지도</div>
    </header>

    <div class="map-wrap">
      <div id="map"></div>
      <div id="panorama"></div>
    
    <!-- PopUp -->
    <div id="overlay"></div>
    <div id="popup">
        <div class="popup-content">
            <span id="popup-close">✖</span>
            <h3 id="popup-title">마커 정보</h3>
            <audio id="popup-audio" controls style="width:90%; margin:10px 0;"></audio>
            <div id="popup-panorama"></div>
        </div>
    </div>

    <!-- 태그 선택 팝업 -->
    <div id="tagPopup">
      <h3>태그 선택</h3>
      <div id="tagList"></div>
      <div id="tagActions">
        <button id="tagCloseBtn">닫기</button>
        <button id="tagSearchBtn" class="primary">검색</button>
      </div>
    </div>

    <!-- 마커 정보 표 팝업 -->
    <div id="infoPopup">
      <h3>마커 정보 표</h3>
      <div id="infoTable"></div>
      <div style="text-align:right;margin-top:10px;">
       <button id="infoCloseBtn">닫기</button>
      </div>
    </div>
  </div>

  <!-- ==================== JS ==================== -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <script>
    // 지도 기본 세팅
    const imgWidth=2754, imgHeight=1556;
    const bounds=[[0,0],[imgHeight,imgWidth]];
    const map=L.map('map',{
        crs:L.CRS.Simple,
        minZoom:-1,
        maxZoom:1,
        maxBounds:bounds,
        maxBoundsViscosity:1.0
    });

    const customIcon=L.icon({
      iconUrl:'marker.svg',
      iconSize:[100,100],
      iconAnchor:[50,75],
      popupAnchor: [0, -40]
    });

    L.imageOverlay("https://i.imgur.com/O5p8OLJ.png",bounds).addTo(map);

    map.fitBounds(bounds); 
    map.setMinZoom(map.getZoom()); 
    map.setMaxBounds(bounds);
    map.on('zoomend',()=>{map.dragging.enable(); map.keyboard.enable();});


    // ================================    
    // 마커 데이터
    // ================================
    const markerData = [
      {
        coords: [200, 300],
        name: "전망대",
        pano: "images/1.jpg",
        audio: "3.m4a",
        tags: ["자연", "조용함"]
      }
    ];

    // ================================
    // 공통: 마커 생성 함수
    // ================================
    function createMarker(item) {
      const marker = L.marker(item.coords, {icon: customIcon}).addTo(map);
      const tagText=item.tags&&item.tags.length? "<br><small>#"+item.tags.join(" #")+"</small>":"";
      marker.bindTooltip(item.name, {direction:"bottom"});
      marker.on("click", () => showPanorama(item.name, item.pano, item.audio));
      return marker;
    }
    markerData.forEach(createMarker);
    
        const popup=document.getElementById("popup"),
              popupTitle=document.getElementById("popup-title"),
              popupClose=document.getElementById("popup-close");

    // ================================
    // 📍 마커 추가 버튼
    // ================================
    let addMode = false;
    let addBtnRef = null; // 📍 버튼 참조 저장

    const AddMarkerControl = L.Control.extend({
      onAdd: function(map) {
        const btn = L.DomUtil.create("div", "leaflet-control-addmarker leaflet-bar");
        btn.innerHTML = "📍";
        btn.title = "마커 추가";
        addBtnRef = btn;

        L.DomEvent.disableClickPropagation(btn);
        L.DomEvent.disableScrollPropagation(btn);

        btn.onclick = function(e) {
          e.preventDefault();
          addMode = !addMode;
          btn.classList.toggle("active", addMode);
          if(addMode) alert("지도에서 위치를 클릭해 새 마커를 추가하세요.");
        };
        return btn;
      }
    });

    // ===== ℹ️ 표보기 버튼 =====
    const InfoTableControl=L.Control.extend({
      onAdd:function(map){
        const btn=L.DomUtil.create("div","leaflet-control-infotable leaflet-bar");
        btn.innerHTML="ℹ️"; 
        btn.title="마커 정보 표 보기";

        L.DomEvent.disableClickPropagation(btn); 
        L.DomEvent.disableScrollPropagation(btn);
        btn.onclick=e=>{
          e.preventDefault(); 
          openInfoPopup();
        };
        return btn;
      }
    });

    const infoPopup=document.getElementById("infoPopup");
    const infoTable=document.getElementById("infoTable");
    const infoCloseBtn=document.getElementById("infoCloseBtn");
    function openInfoPopup(){
      if(markerData.length===0){
        infoTable.innerHTML="<p style='color:#666'>등록된 마커가 없습니다.</p>";
      }
      else{
        let html="<table><thead><tr><th>이름</th><th>태그</th></tr></thead><tbody>";
        markerData.forEach(m=>{
          const tagText=m.tags&&m.tags.length?"#"+m.tags.join(" #"):"-";
          html+=`<tr><td>${m.name}</td><td>${tagText}</td></tr>`;
        });
        html+="</tbody></table>";
        infoTable.innerHTML=html;
      }
      overlay.classList.add("show"); 
      infoPopup.style.display="block";
    }
    function closeInfoPopup(){ 
      infoPopup.style.display="none"; 
      overlay.classList.remove("show"); 
    }
    infoCloseBtn.onclick=closeInfoPopup;

    // ===== 🔎 태그 검색 버튼 =====
    const TagSearchControl=L.Control.extend({onAdd:function(map){
      const btn=L.DomUtil.create("div","leaflet-control-tagsearch leaflet-bar");
      btn.innerHTML="🔎"; 
      btn.title="태그 검색";

      L.DomEvent.disableClickPropagation(btn); 
      L.DomEvent.disableScrollPropagation(btn);
      btn.onclick=e=>{
        e.preventDefault(); 
        openTagPopup();
      };
      return btn;
    }});

    const tagPopup=document.getElementById("tagPopup");
    const tagList=document.getElementById("tagList");
    const tagSearchBtn=document.getElementById("tagSearchBtn");
    const tagCloseBtn=document.getElementById("tagCloseBtn");
    let selectedTags=[];

    function openTagPopup(){
      const allTags=[...new Set(markerData.flatMap(m=>m.tags||[]))];
      tagList.innerHTML=""; 
      selectedTags=[];
      if(allTags.length===0){ tagList.innerHTML="<p style='color:#666'>등록된 태그가 없습니다.</p>"; }
      else{
        allTags.forEach(tag=>{
          const chip=document.createElement("button");
          chip.className="tag-chip"; 
          chip.textContent="#"+tag;
          chip.onclick=()=>{
            chip.classList.toggle("selected"); 
            if(chip.classList.contains("selected")) selectedTags.push(tag); 
            else selectedTags=selectedTags.filter(t=>t!==tag);
          };
          tagList.appendChild(chip);
        });
      }
      overlay.classList.add("show"); 
      tagPopup.style.display="block";
    }
    function closeTagPopup(){ 
      tagPopup.style.display="none"; 
      overlay.classList.remove("show"); 
      selectedTags=[]; 
    }
    tagCloseBtn.onclick=closeTagPopup;
    tagSearchBtn.onclick=()=>{
      if(selectedTags.length===0){ 
        alert("태그를 선택하세요!"); 
        return; 
      }

      const matched=markerData.filter(m=>selectedTags.every(t=>m.tags&&m.tags.includes(t)));

      if(matched.length===0){ 
        alert("조건을 만족하는 마커가 없습니다."); 
        return; 
      }
      const highlights=[];
      matched.forEach(item=>{
        const circle=L.circleMarker(item.coords,{radius:25,color: "black" ,weight:3,fillColor:"#FFFF00",fillOpacity:0.35}).addTo(map);
        highlights.push(circle);
      });
      setTimeout(()=>highlights.forEach(c=>map.removeLayer(c)),5000);
      closeTagPopup();
    };

    // ===== 📁 저장 버튼 =====
    const InfoControl=L.Control.extend({
      onAdd:function(map){
        const btn=L.DomUtil.create("div","leaflet-control-info leaflet-bar");
        btn.innerHTML="📁"; 
        btn.title="마커 데이터 저장";

        L.DomEvent.disableClickPropagation(btn); 
        L.DomEvent.disableScrollPropagation(btn);
        btn.onclick=e=>{
          e.preventDefault();
          const dataStr=JSON.stringify(markerData,null,2);
          const blob=new Blob([dataStr],{type:"text/plain"});
          const url=URL.createObjectURL(blob);
          const a=document.createElement("a"); 
          a.href=url; 
          a.download="markerData.txt";

          document.body.appendChild(a); 
          a.click(); 
          document.body.removeChild(a); 
          URL.revokeObjectURL(url);
        };
        return btn;
      }
    });

    // ===== 컨트롤 순서: 📍 → ℹ️ → 🔎 → 📁 =====
    map.addControl(new AddMarkerControl({position:"topleft"}));
    map.addControl(new InfoTableControl({position:"topleft"}));
    map.addControl(new TagSearchControl({position:"topleft"}));
    map.addControl(new InfoControl({position:"topleft"}));

    // ===== 지도 클릭으로 새 마커 추가 =====
    map.on("click", function(e){
      if(!addMode) return; 

      const name = prompt("마커 이름을 입력하세요:"); 
      if(!name) return;

      const panoUrl = prompt("파노라마(사진) URL을 입력하세요:"); 
      if(!panoUrl) return;

      const audioUrl = prompt("소리 URL을 입력하세요:"); 
      if(!audioUrl) return;

      const tagsInput = prompt("태그를 입력하세요 (쉼표로 구분, 예: 자연, 조용함):");
      const tags = tagsInput? tagsInput.split(",").map(t=>t.trim()).filter(Boolean):[];

      const newItem = {coords:[e.latlng.lat,e.latlng.lng],name,pano:panoUrl,audio:audioUrl,tags};
      markerData.push(newItem); 
      createMarker(newItem);

      // ✅ 성공적으로 추가된 경우에만 addMode 해제
      addMode = false; 
      if(addBtnRef) addBtnRef.classList.remove("active");
    });


    // 팝업 외부 클릭 시 닫기
    window.addEventListener("click", (e) => {
        if (popup.classList.contains("show") && !popup.querySelector(".popup-content").contains(e.target)) {
            popup.classList.remove("show");
            popup.classList.add("hide");
            setTimeout(() => {
                popup.style.display = "none";
                popup.classList.remove("hide");
                audio.pause();
            }, 300);
        }
    });

    // ================================
    // 파노라마 & 사운드
    // ================================
    let viewer, audio=new Audio();

    const overlay = document.getElementById("overlay");

    function showPanorama(name, panoUrl, audioUrl){
        popupTitle.textContent = name;
        popup.style.display = "block";
        overlay.classList.add("show");
        setTimeout(() => {
            popup.classList.add("show");

            const oldPanorama = document.getElementById("popup-panorama");
            if (oldPanorama) oldPanorama.remove();

            const newPanorama = document.createElement("div");
            newPanorama.id = "popup-panorama";
            newPanorama.style.width = "750px";
            newPanorama.style.height = "600px";
            newPanorama.style.borderRadius = "8px";
            newPanorama.style.marginTop = "10px";

            popup.querySelector(".popup-content").appendChild(newPanorama);

            // 🚀 새로운 pannellum 뷰어 생성
            viewer = pannellum.viewer('popup-panorama', {
                type: "equirectangular",
                panorama: panoUrl,
                autoLoad: true,
                // title: name
            });

            // 오디오 실행
            const audioEl = document.getElementById("popup-audio");
            audioEl.src = audioUrl;
            audioEl.loop = true;
            audio.volume=1.0;
            audioEl.play();
        }, 10);
    }

    function closePopup(){
        popup.classList.remove("show");
        overlay.classList.remove("show");
        audio.pause();
    }

    popupClose.onclick = closePopup;
    overlay.onclick = closePopup;

    // 사운드 / 종료
    document.getElementById("soundToggle").onclick=function(){
      if(audio.paused){audio.play();this.textContent="🔊 Sound On";}
      else{audio.pause();this.textContent="🔇 Sound Off";}
    };
    document.getElementById("exitBtn").onclick=()=>{
      document.getElementById("map").style.display="block";
      document.getElementById("panorama").style.display="none";
      document.getElementById("controls").style.display="none";
      audio.pause();
      map.fitBounds(bounds);
    };
  </script>
</body>
</html>
