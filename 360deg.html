<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¶€ì†Œì‚° íŒŒë…¸ë¼ë§ˆ ì†Œë¦¬ ì§€ë„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet & Pannellum -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css" />

  <style>
    :root{
      --page-max-w: 1200px;
      --side-gap: 32px;
      --header-h: 120px;
      --between-gap: 24px;
      --map-bottom-gap: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(135deg, #f9fdfd 0%, #eefdf3 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif;
    }

    .page {
      min-height: 100%;
      max-width: var(--page-max-w);
      margin: 0 auto;
      padding: 0 var(--side-gap);
      display: flex;
      flex-direction: column;
    }

    #header {
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 12px;
      background: #f0fff4;
      border-radius: 14px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      border: 2px solid rgba(0, 0, 0, 0.15);
    }
    #title {
      font-size: 30px;
      font-weight: 800;
      color: #555;
      text-shadow: 1px 2px 6px rgba(0,0,0,0.25);
    }

    .map-wrap {
      position: relative;
      height: calc(95vh - var(--header-h) - var(--between-gap) - var(--map-bottom-gap));
      margin-top: var(--between-gap);
      margin-bottom: var(--map-bottom-gap);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      background: #eef7ff;
      border: 2px solid rgba(0, 0, 0, 0.12);
    }

    /* .map-wrap {
      position: relative;
      height: calc(100vh - var(--header-h) - var(--between-gap) - var(--map-bottom-gap));
      margin-top: var(--between-gap);
      margin-bottom: var(--map-bottom-gap);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      background: #eef7ff;
      border: 2px solid rgba(0, 0, 0, 0.12);
    } */

    #map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    
    .leaflet-container { background: transparent !important; }
    
    #controls {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1000;
      display: none;
    }
    #controls button {
      margin-right: 8px;
      padding: 8px 12px;
      border: 0;
      border-radius: 8px;
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      font-weight: 600;
      color: #083a57;
      cursor: pointer;
    }
    #controls button:hover { background: #ffffff; }
    
    
    /* ğŸ“ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .leaflet-control-addmarker {
      background: white;
      border: 1px solid #ccc;
      width: 30px;
      height: 30px;
      line-height: 28px;
      font-size: 18px;
      text-align: center;
      cursor: pointer;
    }
    .leaflet-control-addmarker.active { background: #ffe082; }
    
    /* â„¹ï¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .leaflet-control-info {
      background: white;
      border: 1px solid #ccc;
      width: 30px;
      height: 30px;
      line-height: 28px;
      font-size: 18px;
      text-align: center;
      cursor: pointer;
    }
    
    
    @media (max-width: 640px){
      :root{ --header-h: 96px; --side-gap: 16px; }
      #title{ font-size: 28px; }
    }

    #popup {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: white;
      padding: 16px;
      border-radius: 20px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      width: 90%;
      max-width: 800px;
      max-height: 75vh;
      overflow-y: auto;
      display: none;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      /* overflow: hidden; */
    }
    
    /* #popup {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      width: 800px;
      max-width: 90%;
      display: none;
      flex-direction: column;
      align-items: center;
    } */
    #popup.show {
      display: flex;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    #popup.hide {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
    }
    #popup .popup-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: auto;
    }
    #popup-close {
      position: absolute;
      top: 10px;
      right: 12px;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      color: #444;
    }
    /* #popup-close:hover {
      color: red;
    } */

    /* #popup-panorama {
        width: 750px;
        height: 400px;   /* ì›í•˜ëŠ” í¬ê¸° (ì˜ˆ: 300~400px) */
        /* border-radius: 8px;
        margin-top: 10px;
    } */ */
    #popup-panorama {
      width: 100%;
      max-width: 800px;
      height: 10vh;
      max-height: 10vh;
      border-radius: 0;
      margin-top: 10px;
    }
    #popup-audio {
      width: 80%;   /* ì›í•˜ëŠ” ë¹„ìœ¨ (ì˜ˆ: 60%) */
      max-width: 300px;  /* ìµœëŒ€ ê³ ì • í¬ê¸° */
      /* height: 20%; */
      /* max-height: 10px; */
      margin: 5px;
    }
    
    #overlay {
      position: fixed;
      inset: 0;   /* top, left, right, bottom = 0 */
      background: rgba(0,0,0,0.3);
      z-index: 1500;
      display: none;
    }
    #overlay.show { display: block; }

    
    /* íƒœê·¸ ì„ íƒ íŒì—… */
    /* #tagPopup {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#fff; padding:16px; border-radius:12px;
      box-shadow:0 12px 32px rgba(0,0,0,0.25);
      z-index:2200; display:none;
      width:360px; max-width:90%;
    } */
    #tagPopup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2200;
      display: none;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #tagList { display:flex; flex-wrap:wrap; gap:8px; max-height:180px; overflow:auto; }
    .tag-chip {
      border:1px solid #ddd; border-radius:999px;
      padding:6px 10px; cursor:pointer; background:#fafafa; font-size:13px;
    }
    .tag-chip.selected { background:#ffe082; border-color:#f5c84c; }
    #tagActions { margin-top:12px; display:flex; gap:8px; justify-content:flex-end; }
    #tagActions button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; cursor:pointer; background:#fff; }
    #tagActions button.primary { background:#1e90ff; color:#fff; border-color:#1e90ff; }

    /* ë§ˆì»¤ ì •ë³´ í‘œ íŒì—… */
    /* #infoPopup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2200;
      display: none;
      width: 400px;
      max-width: 90%;
    } */

    #infoPopup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      z-index: 2200;
      display: none;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #infoPopup h3 { margin-top:0; margin-bottom:12px; }
    #infoTable table { width:100%; border-collapse: collapse; }
    #infoTable th, #infoTable td {
      border:1px solid #ddd; padding:6px 8px; font-size:14px; text-align:left;
    }
    #infoTable th { background:#f5f5f5; }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 640px) {
      #popup { padding: 12px; }
      #popup-panorama { height: 35vh; }
      #tagPopup, #infoPopup { padding: 12px; }
    }

    /* íƒœë¸”ë¦¿ ëŒ€ì‘ */
    @media (min-width: 641px) and (max-width: 1024px) {
      #popup-panorama { height: 45vh; }
    }

    /* ë°ìŠ¤í¬íƒ‘ ëŒ€ì‘ */
    @media (min-width: 1025px) {
      #popup-panorama { height: 500px; }
    }


    .leaflet-container { background:transparent !important; }
    .leaflet-control-addmarker,
    .leaflet-control-infotable,
    .leaflet-control-tagsearch,
    .leaflet-control-info {
      background:white; border:1px solid #ccc;
      width:30px; height:30px; line-height:28px;
      font-size:18px; text-align:center; cursor:pointer;
    }
    .leaflet-control-addmarker.active { background:#ffe082; }

    .leaflet-tooltip {
      background-color: rgba(255,255,255,0.5);
      border-radius: 12px;
      color: #333; font-weight: bold; font-size: 12px;
      padding: 6px 10px;
    }
  </style>

  

</head>

<body>
  <!-- ==================== HTML ==================== -->
  <div class="page">
    <header id="header">
      <div id="title">ğŸ—ºï¸ ë¶€ì†Œì‚° íŒŒë…¸ë¼ë§ˆ ì§€ë„</div>
    </header>

    <div class="map-wrap">
      <div id="map"></div>
      <div id="panorama"></div>
    
    <!-- PopUp -->
    <div id="overlay"></div>
    <div id="popup">
        <div class="popup-content">
            <span id="popup-close">âœ–</span>
            <h3 id="popup-title">ë§ˆì»¤ ì •ë³´</h3>
            <audio id="popup-audio" controls></audio>
            <div id="popup-panorama"></div>
        </div>
    </div>

    <!-- íƒœê·¸ ì„ íƒ íŒì—… -->
    <div id="tagPopup">
      <h3>íƒœê·¸ ì„ íƒ</h3>
      <div id="tagList"></div>
      <div id="tagActions">
        <button id="tagCloseBtn">ë‹«ê¸°</button>
        <button id="tagSearchBtn" class="primary">ê²€ìƒ‰</button>
      </div>
    </div>

    <!-- ë§ˆì»¤ ì •ë³´ í‘œ íŒì—… -->
    <div id="infoPopup">
      <h3>ë§ˆì»¤ ì •ë³´ í‘œ</h3>
      <div id="infoTable"></div>
      <div style="text-align:right;margin-top:10px;">
       <button id="infoCloseBtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ==================== JS ==================== -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <script>
    // ì§€ë„ ê¸°ë³¸ ì„¸íŒ…
    const imgWidth=2754, imgHeight=1556;
    const bounds=[[0,0],[imgHeight,imgWidth]];
    const map=L.map('map',{
        crs:L.CRS.Simple,
        minZoom:-2,
        maxZoom:1,
        maxBounds:bounds,
        maxBoundsViscosity:1.0,
        zoomDelta: 0.25,
        zoomSnap: 0.25
    });

    const customIcon=L.icon({
      iconUrl:'marker.svg',
      iconSize:[30,30],
      iconAnchor:[15,30],
      popupAnchor: [0, -30]
    });

    // const customIcon = L.divIcon({
    //   html: '<img src="marker.svg" style="width:40px;height:40px;">',
    //   className: '',   // Leaflet ê¸°ë³¸ í´ë˜ìŠ¤ ì œê±° (í° ë„¤ëª¨ ë°°ê²½ ì—†ì•°)
    //   iconSize: [100, 100],
    //   iconAnchor: [50, 75],
    //   popupAnchor: [0, -40]
    // });

    L.imageOverlay("https://i.imgur.com/O5p8OLJ.png",bounds).addTo(map);

    map.fitBounds(bounds); 
    map.setMinZoom(map.getZoom()-0.5); 
    map.setMaxBounds(bounds);
    map.on('zoomend',()=>{map.dragging.enable(); map.keyboard.enable();});


    // ================================    
    // ë§ˆì»¤ ë°ì´í„°
    // ================================

    const markerData=[
      {coords:[426.80,1398.61], name:"1", pano:"images/1.jpg", audio:"audio/1_ì†Œë¦¬.mp3", tags:["ì‚°ì±…", "ìì—°"]},
      {coords:[470.61,1313.18], name:"2", pano:"images/2.jpg", audio:"audio/2_ì†Œë¦¬.mp3", tags:["ì‚°ì±…"]},
      {coords:[466.61,1260.17], name:"3", pano:"images/3.jpg", audio:"audio/3_ì†Œë¦¬.mp3", tags:["ì‚°ì±…", "ê³µì›", "ì”ë””"]},
      {coords:[438.61,1129.13], name:"4", pano:"images/4.jpg", audio:"audio/4_ì†Œë¦¬.mp3", tags:["ì‚°ì±…", "ê³µì›", "ì”ë””"]},
      {coords:[664.61,1176.19], name:"5", pano:"images/5.jpg", audio:"audio/5_ì†Œë¦¬.mp3", tags:["ì‚°ì±…", "ìì—°"]},
      {coords:[732.61,1271.22], name:"6", pano:"images/6.jpg", audio:"audio/6_ì†Œë¦¬.mp3", tags:["ì‚°ì±…", "ìì—°"]},
      {coords:[898.61,1246.21], name:"7", pano:"images/7.jpg", audio:"audio/7_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[1030.61,1289.21], name:"8", pano:"images/8.jpg", audio:"audio/8_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[1125.61,1251.20], name:"ë‚™í™”ì•”", pano:"images/9.jpg", audio:"audio/9_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°", "ê°•", "ëª…ì†Œ"]},
      {coords:[1161.61,1379.24], name:"êµ¬ë“œë ˆ ì„ ì°©ì¥", pano:"images/10.jpg", audio:"audio/10_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°", "ê°•", "ëª…ì†Œ", "ì„ ì°©ì¥"]},
      {coords:[966.61,1330.22], name:"11", pano:"images/11.jpg", audio:"audio/11_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[859.61,1394.24], name:"12", pano:"images/12.jpg", audio:"audio/12_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[918.61,1663.28], name:"13", pano:"images/13.jpg", audio:"audio/13_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[949.22,1766.57], name:"ê¶ë…€ì‚¬", pano:"images/ê¶ë…€ì‚¬.jpg", audio:"audio/ê¶ë…€ì‚¬_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°", "ê±´ì¶•ë¬¼", "ì ˆ"]},
      {coords:[833.61,1887.26], name:"14", pano:"images/14.jpg", audio:"audio/14_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[649.61,1809.24], name:"15", pano:"images/15.jpg", audio:"audio/15_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[524.61,1426.13], name:"16", pano:"images/16.jpg", audio:"audio/16_ì†Œë¦¬.mp3", tags:["ìì—°", "ê±´ì¶•ë¬¼", "ì—°ëª»", "ì—°ì"]},
      {coords:[582.61,1480.15], name:"17", pano:"images/17.jpg", audio:"audio/17_ì†Œë¦¬.mp3", tags:["ê±´ì¶•ë¬¼", "ì ˆ"]},
      {coords:[646.61,1746.22], name:"18", pano:"images/18.jpg", audio:"audio/18_ì†Œë¦¬.mp3", tags:["ê±´ì¶•ë¬¼", "ì ˆ"]},
      {coords:[577.61,1370.11], name:"19", pano:"images/19.jpg", audio:"audio/19_ì†Œë¦¬.mp3", tags:["ì‚°ì±…", "ìì—°"]},
      {coords:[825.61,1237.08], name:"20", pano:"images/20.jpg", audio:"audio/20_ì†Œë¦¬.mp3", tags:["ë“±ì‚°", "ìì—°"]},
      {coords:[328.61,1284.18], name:"21", pano:"images/21.jpg", audio:"audio/21_ì†Œë¦¬.mp3", tags:["ë„ë¡œ"]},
      {coords:[351.61,1398.22], name:"22", pano:"images/22.jpg", audio:"audio/22_ì†Œë¦¬.mp3", tags:["ì”ë””"]},
      {coords:[410.61,1311.19], name:"23", pano:"images/23.jpg", audio:"audio/23_ì†Œë¦¬.mp3", tags:["ì”ë””", "ì—°ì"]},
      {coords:[407.61,1223.17], name:"24", pano:"images/24.jpg", audio:"audio/24_ì†Œë¦¬.mp3", tags:["ê±´ì¶•ë¬¼", "ì ˆ"]},
      {coords:[632.61,933.09], name:"25", pano:"images/25.jpg", audio:"audio/25_ì†Œë¦¬.mp3", tags:["ê³µì›", "ê±´ì¶•ë¬¼", "ì‚°ì±…"]},
      {coords:[483.61,1068.12], name:"26", pano:"images/26.jpg", audio:"audio/26_ì†Œë¦¬.mp3", tags:["ì¹´í˜", "ìŒì‹", "ê±´ì¶•ë¬¼"]},
      {coords:[356.61,1178.15], name:"27", pano:"images/27.jpg", audio:"audio/27_ì†Œë¦¬.mp3", tags:["ìŒì‹", "ë„ë¡œ"]},
      {coords:[336.61,1342.17], name:"28", pano:"images/28.jpg", audio:"audio/28_ì†Œë¦¬.mp3", tags:["ë„ë¡œ"]},
      {coords:[420.61,1460.19], name:"29", pano:"images/29.jpg", audio:"audio/29_ì†Œë¦¬.mp3", tags:["ê±´ì¶•ë¬¼", "ì ˆ", "ë„ë¡œ"]},
      {coords:[372.61,1585.22], name:"30", pano:"images/30.jpg", audio:"audio/30_ì†Œë¦¬.mp3", tags:["í•™êµ", "ë„ë¡œ"]},
      {coords:[294.61,1733.17], name:"31", pano:"images/31.jpg", audio:"audio/31_ì†Œë¦¬.mp3", tags:["ë„ë¡œ"]},
      {coords:[500.61,2084.22], name:"32", pano:"images/32.jpg", audio:"audio/32_ì†Œë¦¬.mp3", tags:["ë„ë¡œ"]},
      {coords:[709.61,2136.24], name:"33", pano:"images/33.jpg", audio:"audio/33_ì†Œë¦¬.mp3", tags:["ë„ë¡œ"]},
      {coords:[984.61,2018.206], name:"34", pano:"images/34.jpg", audio:"audio/34_ì†Œë¦¬.mp3", tags:["ë„ë¡œ"]},
      {coords:[636.61,864.16], name:"35", pano:"images/35.jpg", audio:"audio/35_ì†Œë¦¬.mp3", tags:["ê³µì›", "ê±´ì¶•ë¬¼", "ì‚°ì±…"]},
    ];


    // ================================
    // ê³µí†µ: ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
    // ================================
    function createMarker(item) {
      const marker = L.marker(item.coords, {icon: customIcon}).addTo(map);
      const tagText=item.tags&&item.tags.length? "<br><small>#"+item.tags.join(" #")+"</small>":"";
      marker.bindTooltip(item.name, {direction:"bottom"});
      marker.on("click", () => showPanorama(item.name, item.pano, item.audio));
      return marker;
    }
    markerData.forEach(createMarker);
    
        const popup=document.getElementById("popup"),
              popupTitle=document.getElementById("popup-title"),
              popupClose=document.getElementById("popup-close");

    // ================================
    // ğŸ“ ë§ˆì»¤ ì¶”ê°€ ë²„íŠ¼
    // ================================
    let addMode = false;
    let addBtnRef = null; // ğŸ“ ë²„íŠ¼ ì°¸ì¡° ì €ì¥

    const AddMarkerControl = L.Control.extend({
      onAdd: function(map) {
        const btn = L.DomUtil.create("div", "leaflet-control-addmarker leaflet-bar");
        btn.innerHTML = "ğŸ“";
        btn.title = "ë§ˆì»¤ ì¶”ê°€";
        addBtnRef = btn;

        L.DomEvent.disableClickPropagation(btn);
        L.DomEvent.disableScrollPropagation(btn);

        btn.onclick = function(e) {
          e.preventDefault();
          addMode = !addMode;
          btn.classList.toggle("active", addMode);
          if(addMode) alert("ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•´ ìƒˆ ë§ˆì»¤ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.");
        };
        return btn;
      }
    });

    // ===== â„¹ï¸ í‘œë³´ê¸° ë²„íŠ¼ =====
    const InfoTableControl=L.Control.extend({
      onAdd:function(map){
        const btn=L.DomUtil.create("div","leaflet-control-infotable leaflet-bar");
        btn.innerHTML="â„¹ï¸"; 
        btn.title="ë§ˆì»¤ ì •ë³´ í‘œ ë³´ê¸°";

        L.DomEvent.disableClickPropagation(btn); 
        L.DomEvent.disableScrollPropagation(btn);
        btn.onclick=e=>{
          e.preventDefault(); 
          openInfoPopup();
        };
        return btn;
      }
    });

    const infoPopup=document.getElementById("infoPopup");
    const infoTable=document.getElementById("infoTable");
    const infoCloseBtn=document.getElementById("infoCloseBtn");
    function openInfoPopup(){
      if(markerData.length===0){
        infoTable.innerHTML="<p style='color:#666'>ë“±ë¡ëœ ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
      }
      else{
        let html="<table><thead><tr><th>ì´ë¦„</th><th>íƒœê·¸</th></tr></thead><tbody>";
        markerData.forEach(m=>{
          const tagText=m.tags&&m.tags.length?"#"+m.tags.join(" #"):"-";
          html+=`<tr><td>${m.name}</td><td>${tagText}</td></tr>`;
        });
        html+="</tbody></table>";
        infoTable.innerHTML=html;
      }
      overlay.classList.add("show"); 
      infoPopup.style.display="block";
    }
    function closeInfoPopup(){ 
      infoPopup.style.display="none"; 
      overlay.classList.remove("show"); 
    }
    infoCloseBtn.onclick=closeInfoPopup;

    // ===== ğŸ” íƒœê·¸ ê²€ìƒ‰ ë²„íŠ¼ =====
    const TagSearchControl=L.Control.extend({onAdd:function(map){
      const btn=L.DomUtil.create("div","leaflet-control-tagsearch leaflet-bar");
      btn.innerHTML="ğŸ”"; 
      btn.title="íƒœê·¸ ê²€ìƒ‰";

      L.DomEvent.disableClickPropagation(btn); 
      L.DomEvent.disableScrollPropagation(btn);
      btn.onclick=e=>{
        e.preventDefault(); 
        openTagPopup();
      };
      return btn;
    }});

    const tagPopup=document.getElementById("tagPopup");
    const tagList=document.getElementById("tagList");
    const tagSearchBtn=document.getElementById("tagSearchBtn");
    const tagCloseBtn=document.getElementById("tagCloseBtn");
    let selectedTags=[];

    function openTagPopup(){
      const allTags=[...new Set(markerData.flatMap(m=>m.tags||[]))];
      tagList.innerHTML=""; 
      selectedTags=[];
      if(allTags.length===0){ tagList.innerHTML="<p style='color:#666'>ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; }
      else{
        allTags.forEach(tag=>{
          const chip=document.createElement("button");
          chip.className="tag-chip"; 
          chip.textContent="#"+tag;
          chip.onclick=()=>{
            chip.classList.toggle("selected"); 
            if(chip.classList.contains("selected")) selectedTags.push(tag); 
            else selectedTags=selectedTags.filter(t=>t!==tag);
          };
          tagList.appendChild(chip);
        });
      }
      overlay.classList.add("show"); 
      tagPopup.style.display="block";
    }
    function closeTagPopup(){ 
      tagPopup.style.display="none"; 
      overlay.classList.remove("show"); 
      selectedTags=[]; 
    }
    tagCloseBtn.onclick=closeTagPopup;
    tagSearchBtn.onclick=()=>{
      if(selectedTags.length===0){ 
        alert("íƒœê·¸ë¥¼ ì„ íƒí•˜ì„¸ìš”!"); 
        return; 
      }

      const matched=markerData.filter(m=>selectedTags.every(t=>m.tags&&m.tags.includes(t)));

      if(matched.length===0){ 
        alert("ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤."); 
        return; 
      }
      const highlights=[];
      matched.forEach(item=>{
        const circle=L.circleMarker(item.coords,{radius:25,color: "black" ,weight:3,fillColor:"#FFFF00",fillOpacity:0.35}).addTo(map);
        highlights.push(circle);
      });
      setTimeout(()=>highlights.forEach(c=>map.removeLayer(c)),5000);
      closeTagPopup();
    };

    // ===== ğŸ“ ì €ì¥ ë²„íŠ¼ =====
    const InfoControl=L.Control.extend({
      onAdd:function(map){
        const btn=L.DomUtil.create("div","leaflet-control-info leaflet-bar");
        btn.innerHTML="ğŸ“"; 
        btn.title="ë§ˆì»¤ ë°ì´í„° ì €ì¥";

        L.DomEvent.disableClickPropagation(btn); 
        L.DomEvent.disableScrollPropagation(btn);
        btn.onclick=e=>{
          e.preventDefault();
          const dataStr=JSON.stringify(markerData,null,2);
          const blob=new Blob([dataStr],{type:"text/plain"});
          const url=URL.createObjectURL(blob);
          const a=document.createElement("a"); 
          a.href=url; 
          a.download="markerData.txt";

          document.body.appendChild(a); 
          a.click(); 
          document.body.removeChild(a); 
          URL.revokeObjectURL(url);
        };
        return btn;
      }
    });

    // ===== ì»¨íŠ¸ë¡¤ ìˆœì„œ: ğŸ“ â†’ â„¹ï¸ â†’ ğŸ” â†’ ğŸ“ =====
    map.addControl(new AddMarkerControl({position:"topleft"}));
    map.addControl(new InfoTableControl({position:"topleft"}));
    map.addControl(new TagSearchControl({position:"topleft"}));
    map.addControl(new InfoControl({position:"topleft"}));

    // ===== ì§€ë„ í´ë¦­ìœ¼ë¡œ ìƒˆ ë§ˆì»¤ ì¶”ê°€ =====
    map.on("click", function(e){
      if(!addMode) return; 

      const name = prompt("ë§ˆì»¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:"); 
      if(!name) return;

      const panoUrl = prompt("íŒŒë…¸ë¼ë§ˆ(ì‚¬ì§„) URLì„ ì…ë ¥í•˜ì„¸ìš”:"); 
      if(!panoUrl) return;

      const audioUrl = prompt("ì†Œë¦¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:"); 
      if(!audioUrl) return;

      const tagsInput = prompt("íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: ìì—°, ì¡°ìš©í•¨):");
      const tags = tagsInput? tagsInput.split(",").map(t=>t.trim()).filter(Boolean):[];

      const newItem = {coords:[e.latlng.lat,e.latlng.lng],name,pano:panoUrl,audio:audioUrl,tags};
      markerData.push(newItem); 
      createMarker(newItem);

      // âœ… ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ëœ ê²½ìš°ì—ë§Œ addMode í•´ì œ
      addMode = false; 
      if(addBtnRef) addBtnRef.classList.remove("active");
    });


    // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", (e) => {
        if (popup.classList.contains("show") && !popup.querySelector(".popup-content").contains(e.target)) {
            popup.classList.remove("show");
            popup.classList.add("hide");
            setTimeout(() => {
                popup.style.display = "none";
                popup.classList.remove("hide");
                
                const audioEl = document.getElementById("popup-audio");
                audioEl.pause();
                audioEl.currentTime = 0;
            }, 300);
        }
    });

    // ================================
    // íŒŒë…¸ë¼ë§ˆ & ì‚¬ìš´ë“œ
    // ================================
    let viewer, audio=new Audio();

    const overlay = document.getElementById("overlay");

    function showPanorama(name, panoUrl, audioUrl){
        popupTitle.textContent = name;
        popup.style.display = "block";
        overlay.classList.add("show");
        setTimeout(() => {
            popup.classList.add("show");

            const oldPanorama = document.getElementById("popup-panorama");
            if (oldPanorama) oldPanorama.remove();

            const newPanorama = document.createElement("div");
            newPanorama.id = "popup-panorama";
            // newPanorama.style.width = "750px";
            // newPanorama.style.height = "600px";
            // newPanorama.style.borderRadius = "8px";
            // newPanorama.style.marginTop = "10px";

            popup.querySelector(".popup-content").appendChild(newPanorama);

            // ğŸš€ ìƒˆë¡œìš´ pannellum ë·°ì–´ ìƒì„±
            viewer = pannellum.viewer('popup-panorama', {
                type: "equirectangular",
                panorama: panoUrl,
                autoLoad: true,
                // title: name
            });

            // ì˜¤ë””ì˜¤ ì‹¤í–‰
            const audioEl = document.getElementById("popup-audio");
            audioEl.src = audioUrl;
            audioEl.loop = true;
            audio.volume=1.0;
            audioEl.play();
        }, 10);
    }

    function closePopup(){
        popup.classList.remove("show");
        overlay.classList.remove("show");
        
        const audioEl = document.getElementById("popup-audio");
        audioEl.pause();      
        audioEl.currentTime = 0; 

        popup.style.display = "none";
    }

    popupClose.onclick = closePopup;
    overlay.onclick = closePopup;

    // ì‚¬ìš´ë“œ / ì¢…ë£Œ
    document.getElementById("soundToggle").onclick=function(){
      if(audio.paused){audio.play();this.textContent="ğŸ”Š Sound On";}
      else{audio.pause();this.textContent="ğŸ”‡ Sound Off";}
    };
    document.getElementById("exitBtn").onclick=()=>{
      document.getElementById("map").style.display="block";
      document.getElementById("panorama").style.display="none";
      document.getElementById("controls").style.display="none";
      audio.pause();
      map.fitBounds(bounds);
    };
  </script>
</body>
</html>

